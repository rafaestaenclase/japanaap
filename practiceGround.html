<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
<title>Práctica</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  /* mismas variables del index original */
  --bg: #0B0B0E;
  --fg: #E8E8E8;
  --muted: #bdbdbd;
  --card-bg: rgba(255,255,255,0.02);
  --card-bg-strong: rgba(255,255,255,0.10);
  --border: #3a3a3a;
  --accent: #888;
  --panel-glass: rgba(255,255,255,0.02);
  --panel-glass-strong: rgba(255,255,255,0.06);
  --success-tone: rgba(255,255,255,0.12); /* sutil acorde al estilo */
}

/* Reset básico + accesibilidad */
*{ box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; color:var(--fg); }
html,body{ height:100%; margin:0; padding:0; background:var(--bg); font-family: "Noto Sans JP", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; -webkit-font-smoothing:antialiased; }
body{ display:flex; flex-direction:column; align-items:center; min-height:100vh; }

/* Header (oscuro, sutil) */
header{
  width:100%;
  padding:10px 18px;
  display:flex;
  justify-content:flex-start;
  align-items:center;
  position:fixed; top:0; left:0;
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  border-bottom: 1px solid rgba(255,255,255,0.02);
  z-index:120;
}
header h1{ margin:0; font-size:clamp(1.1rem,4vw,1.4rem); color:var(--fg); font-weight:600; }
.subsection{ font-weight:400; font-size:0.85rem; color:var(--muted); margin-left:8px; }

/* Back button estilo 'index' */
.back-btn{
  height:38px; width:38px; display:flex; align-items:center; justify-content:center;
  border-radius:8px; margin-right:12px; cursor:pointer; color:var(--fg);
  background: none; border: 1px solid rgba(255,255,255,0.03);
  transition: transform .12s, background .12s;
}
.back-btn:hover{ background: rgba(255,255,255,0.02); transform: translateY(-2px) }

/* Main */
main{
  width:100%;
  max-width:720px;
  padding:20px;
  margin-top:78px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:16px;
}

/* Pregunta */
#question{
  font-size: clamp(1.6rem,6vw,2.6rem);
  text-align:center;
  line-height:1.2;
  width:100%;
  color:var(--fg);
}

/* Input con look del index (panel oscuro, bordes sutiles) */
#answer{
  width:100%;
  padding:12px 14px;
  font-size:1.25rem;
  text-align:center;
  background: var(--card-bg);
  border: 1px solid rgba(255,255,255,0.03);
  border-radius:8px;
  color:var(--fg);
  box-shadow: inset 0 0 8px rgba(255,255,255,0.02);
  transition: border-color .15s, transform .12s;
  caret-color: var(--fg);
}
#answer:focus{
  border-color: rgba(255,255,255,0.08);
  transform: translateY(-2px);
  box-shadow: inset 0 0 12px rgba(255,255,255,0.02);
}

/* Feedback (error) */
#feedback{ font-size:0.95rem; color: #ff7a7a; min-height:1.1em; text-align:center }

/* Botón Ver respuesta con colores del index (panel en vez de azul llamativo) */
#showAnswerBtn{
  height:46px; padding:0 18px; font-weight:600; border:none; border-radius:10px;
  color:var(--fg); background: var(--card-bg-strong); cursor:pointer; font-size:15px;
  box-shadow: inset 0 0 6px rgba(255,255,255,0.02);
  transition: transform .12s, background .12s;
}
#showAnswerBtn:hover{ transform: translateY(-2px); background: rgba(255,255,255,0.12); }

/* Progress pills en paleta neutra (encajan con index) */
#progressPills{ display:flex; gap:8px; justify-content:center; width:100%; max-width:90vw; margin-top:6px; }
.pill{ position:relative; width:18px; height:18px; background: rgba(255,255,255,0.02); border-radius:50%; border:1px solid rgba(255,255,255,0.03); overflow:hidden; }
.pill-fill{ position:absolute; top:0; left:0; bottom:0; width:0%; background: rgba(255,255,255,0.5); border-radius:50% 0 0 50%; transition: width .28s; }
.pill.filled .pill-fill{ width:100%; border-radius:50%; box-shadow: inset 0 0 8px rgba(255,255,255,0.04); }

/* vibrate ligero */
@keyframes vibrate { 10%,30%,50%{transform:translateX(-3px)} 20%,40%,60%{transform:translateX(3px)} }
.pill.vibrate{ animation: vibrate .5s linear }

/* Correct circle: tono sutil, acorde al index (no verde) */
.correct-circle{
  font-size: clamp(4rem, 20vw, 9rem);
  color: var(--fg);
  opacity:0; transform: translate(-50%,-50%) scale(0.85);
  filter: drop-shadow(0 0 6px rgba(255,255,255,0.06));
  transition: opacity .22s, transform .22s;
  position: fixed; top:45%; left:50%; z-index:50; pointer-events:none; user-select:none;
}
.correct-circle.show{ opacity:1; transform: translate(-50%,-50%) scale(1); animation: glowPulse .6s ease forwards; }
@keyframes glowPulse { 50% { filter: drop-shadow(0 0 18px rgba(255,255,255,0.06)); } }

/* Final actions container (aparece al terminar) */
#completionActions{
  display:flex;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
  justify-content:center;
  width:100%;
  max-width:640px;
  flex-direction: column;
}
.action-btn{
  padding:10px 14px;
  min-width:160px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.04);
  background: var(--card-bg-strong);
  color:var(--fg);
  cursor:pointer;
  font-weight:600;
  transition: transform .12s, background .12s;
}
.action-btn:hover{ transform: translateY(-3px); background: rgba(255,255,255,0.12); }

/* responsive */
@media (max-width:600px){
  main{ padding:16px; margin-top:72px }
  #question{ font-size:2.2rem }
  #answer{ font-size:1.05rem }
  .action-btn{ min-width:130px; font-size:14px }
}
</style>
</head>
<body>
<header>
  <button id="exitBtn" class="back-btn" title="Volver">←</button>
  <h1 id="pageTitle">Práctica <span class="subsection"></span></h1>
</header>

<main id="mainContent">
  <div id="question"></div>
  <input id="answer" placeholder="Escribe en japonés" autocomplete="off" />
  <div id="feedback" aria-live="polite"></div>
  <div id="progressPills" role="progressbar" aria-label="Progreso"></div>
  <button id="showAnswerBtn">Ver respuesta</button>

  <!-- Aquí aparecerán las acciones al completar -->
  <div id="completionActions" aria-hidden="true" style="display:none;"></div>
</main>

<div class="correct-circle" id="correctCircle">〇</div>

<!-- Lista y sonidos (mantén las rutas) -->
<script src="js/allLists.js"></script>

<script>
/* ---------- Navegación / referencias ---------- */
document.getElementById("exitBtn").onclick = () => location.href = "index.html";

const answerEl = document.getElementById("answer");
const feedbackEl = document.getElementById("feedback");
const questionEl = document.getElementById("question");
const correctCircle = document.getElementById("correctCircle");
const showAnswerBtn = document.getElementById("showAnswerBtn");
const progressPills = document.getElementById("progressPills");
const completionActions = document.getElementById("completionActions");

const params = new URLSearchParams(location.search);
const { play, exam, level: playingLevelRaw } = Object.fromEntries(params);
const playingLevel = playingLevelRaw !== undefined ? Number(playingLevelRaw) : undefined;

/* Reconstruir ALL_LISTS desde allLists.js (compatibilidad) */
const ALL_LISTS = [];
for (const k in window) {
  if (k.endsWith("List") && window[k] != null && window[k] !== undefined) ALL_LISTS.push(window[k]);
}

/* Filtrado / preparación de preguntas */
let filteredQuizList = [];
let section = "", subSection = "";

function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
function setPageTitle(main, sub=""){ document.getElementById("pageTitle").innerHTML = sub ? `${main} <span class="subsection">[${sub}]</span>` : main; }

/* Cargar preguntas según params (mismo comportamiento que tenías) */
if (exam) {
  const selections = exam.split(","); const subLists = []; const names = [];
  selections.forEach(sel => {
    const [listName, levelStr] = sel.split("-");
    const cur = ALL_LISTS.find(l => l.listName === listName);
    if (!cur) return;
    if (!section) section = cur.listName;
    const levelData = cur.levels.find(ll => String(ll.level) == String(levelStr) || ll.name === levelStr);
    if (levelData) {
      subLists.push(levelData.items.map(it => ({ ...it, origin: cur.listName, sublevel: levelData.name })));
      names.push(`${cur.listName}: ${levelData.name}`);
    }
  });
  const maxQ = 10;
  const total = subLists.length || 1;
  const base = Math.floor(maxQ / total);
  const resto = maxQ % total;
  subLists.forEach((lista,i)=> filteredQuizList.push(...shuffle(lista).slice(0, base + (i < resto ? 1 : 0))));
  shuffle(filteredQuizList);
  setPageTitle("Examen", names.join(", "));
} else if (play) {
  const quizList = ALL_LISTS.find(l => l.listName === play);
  if (quizList && playingLevel !== undefined) {
    const levelIndex = Number(playingLevel);
    filteredQuizList = shuffle((quizList.levels[levelIndex] && quizList.levels[levelIndex].items) || []);
    section = quizList.listName;
    subSection = (quizList.levels[levelIndex] && quizList.levels[levelIndex].name) || "";
    setPageTitle(section, subSection);
  } else if (quizList) {
    filteredQuizList = shuffle(quizList.levels.flatMap(l => l.items || []));
    section = quizList.listName;
    setPageTitle(section);
  }
}

/* Si no hay preguntas */
if (!filteredQuizList.length) {
  questionEl.textContent = "No hay preguntas disponibles.";
  answerEl.style.display = "none";
  showAnswerBtn.style.display = "none";
}

/* Audio (preload & unlock user gesture) */
const correctSound = new Audio("./sounds/small-bell-ring-01a.mp3");
const pillSound = new Audio("./sounds/bell-ringing-05.mp3");
[correctSound, pillSound].forEach(a => { a.preload="auto"; try{ a.load(); }catch{} });

function unlockAudio(){ [correctSound, pillSound].forEach(a=>a.play().then(()=>a.pause()).catch(()=>{})); document.removeEventListener('touchstart', unlockAudio); document.removeEventListener('click', unlockAudio); }
document.addEventListener('touchstart', unlockAudio, { once:true });
document.addEventListener('click', unlockAudio, { once:true });

/* Normalización y comprobación */
function normalizeAnswer(str){
  if (!str) return "";
  return str
  .normalize('NFC')
  .replace(/\s+/g,"")
  .replace(/ヘ/g,"へ")
  .replace(/ー/g,"一")
  .replace(/一/g,"ー")
  .trim();
}

/* Normalización y comprobación (mejorada para aceptar romaji) */
function normalizeRomaji(str){
  if(!str) return "";
  // quitar espacios y guiones, pasar a minúsculas
  let s = String(str).trim().toLowerCase().replace(/[-\s]+/g,"");
  // eliminar diacríticos / macrones (ō,ū,ā → o,u,a)
  s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  // también reemplazar caracteres latino-extendidos por su base (por si hay ō en NFKC)
  s = s.replace(/ō/g,'o').replace(/ō/g,'o').replace(/ū/g,'u').replace(/ā/g,'a').replace(/ē/g,'e').replace(/í/g,'i').replace(/ú/g,'u');
  // opcional: normalizar ō→ou o ō→o depende de tu preferencia; aquí dejamos la versión simple (quita macrones)
  return s;
}

function normalizeKanaOrRomaji(str){
  if(!str) return "";
  // Si contiene letras latinas (romaji), normalizamos como romaji
  const hasLatin = /[A-Za-z]/.test(str);
  if(hasLatin) return normalizeRomaji(str);
  return normalizeAnswer(String(str));
}

function checkAnswer(userInput, item){
  const normalizedInput = normalizeKanaOrRomaji(userInput || "");
  // Preparar respuestas desde item.a (kana/kanji) y posibles alternativos
  const answers = Array.isArray(item.a) ? item.a.slice() : [item.a];
  if (item.alt) answers.push(item.alt);

  // Añadir romaji si existe en item.r (o item.romaji)
  const romajiStr = item.r || item.romaji || "";
  const romajiList = romajiStr ? romajiStr.split(/[,\/]+/).map(s=>s.trim()).filter(Boolean) : [];

  // Comprobar kana/kanji normalizados
  const matchesKana = answers.some(ans => {
    const normAns = normalizeKanaOrRomaji(ans);
    if (!normAns) return false;
    return normalizedInput === normAns;
  });

  if (matchesKana) return true;

  // Si la entrada del usuario es romaji (o el item tiene romaji), comparar romaji normalizado
  const inputLooksRomaji = /[A-Za-z]/.test(userInput || "");
  if (inputLooksRomaji && romajiList.length){
    const normalizedInputRomaji = normalizeRomaji(userInput);
    return romajiList.some(r => normalizeRomaji(r) === normalizedInputRomaji);
  }

  // Además intentar comparar romaji de las respuestas si por alguna razón las respuestas contienen romaji
  // (por ejemplo si en item.a ya hay romaji)
  for(const ans of answers){
    if (/[A-Za-z]/.test(ans)){
      if (normalizeRomaji(ans) === normalizedInput) return true;
    }
  }

  return false;
}


/* Quiz flow */
let index = 0;
let isChecking = false;
let checkTimeout;

function showQuestion(){
  const it = filteredQuizList[index];
  if (!it) return;
  questionEl.textContent = it.q || "";
  feedbackEl.textContent = "";
  answerEl.value = "";
  const sub = document.querySelector("#pageTitle .subsection");
  if (sub) {
    if (it.sublevel) sub.textContent = `[${it.origin || section}: ${it.sublevel}]`;
    else sub.textContent = subSection ? `[${subSection}]` : "";
  }
  answerEl.focus();
  updatePills(index);
}

function buildCompletionUI() {
  // limpia acciones previas
  completionActions.innerHTML = "";
  completionActions.style.display = "flex";
  completionActions.setAttribute('aria-hidden', 'false');

  // Encontrar quizList y nivel actual (si vienen)
  const quizList = play ? ALL_LISTS.find(l => l.listName === play) : null;
  const levelIndex = (quizList && playingLevel !== undefined) ? Number(playingLevel) : null;

  // Botón repetir nivel (si venías de un nivel o no)
  const repeatBtn = document.createElement('button');
  repeatBtn.className = 'action-btn';
  repeatBtn.textContent = 'Repetir este nivel';
  repeatBtn.onclick = () => {
    // recargar la misma URL para repetir
    location.href = location.pathname + location.search;
  };
  completionActions.appendChild(repeatBtn);

  // Botón nivel anterior (si existe)
  if (quizList && levelIndex !== null && levelIndex > 0 && quizList.levels[levelIndex - 1]) {
    const prevName = quizList.levels[levelIndex - 1].name || `Nivel ${levelIndex}`;
    const prevBtn = document.createElement('button');
    prevBtn.className = 'action-btn';
    prevBtn.textContent = `Nivel anterior · ${prevName}`;
    prevBtn.onclick = () => {
      const params = new URLSearchParams(location.search);
      params.set('level', String(levelIndex - 1));
      params.set('play', quizList.listName);
      location.href = `${location.pathname}?${params.toString()}`;
    };
    completionActions.appendChild(prevBtn);
  }

  // Botón siguiente nivel (si existe)
  if (quizList && levelIndex !== null && quizList.levels[levelIndex + 1]) {
    const nextName = quizList.levels[levelIndex + 1].name || `Nivel ${levelIndex + 2}`;
    const nextBtn = document.createElement('button');
    nextBtn.className = 'action-btn';
    nextBtn.textContent = `Siguiente nivel · ${nextName}`;
    nextBtn.onclick = () => {
      const params = new URLSearchParams(location.search);
      params.set('level', String(levelIndex + 1));
      params.set('play', quizList.listName);
      location.href = `${location.pathname}?${params.toString()}`;
    };
    completionActions.appendChild(nextBtn);
  }

  // Botón volver al índice siempre disponible
  const indexBtn = document.createElement('button');
  indexBtn.className = 'action-btn';
  indexBtn.textContent = 'Volver al índice';
  indexBtn.onclick = () => location.href = 'index.html';
  completionActions.appendChild(indexBtn);
}

function nextQuestion(){
  index++;
  if (index < filteredQuizList.length) {
    resetShowAnswer();
    showQuestion();
  } else {
    updatePills(index);
    questionEl.textContent = "¡Completado!";
    answerEl.style.display = "none";
    showAnswerBtn.style.display = "none";
    correctCircle.classList.add("show");

    // construiremos la UI de acciones (repetir, prev, next) y la mostramos
    setTimeout(()=> {
      correctCircle.classList.remove("show");
      buildCompletionUI();
    }, 420);

    // quitar el document.onclick que antes redirigía
    document.onclick = null;
  }
}

function showCorrect(){
  feedbackEl.textContent = "";
  correctCircle.classList.add("show");
  try{ correctSound.currentTime = 0; correctSound.play(); }catch(e){}
  setTimeout(()=>{ correctCircle.classList.remove("show"); nextQuestion(); isChecking = false; }, 700);
}

/* Input en vivo (debounce ligero) */
answerEl.addEventListener('input', () => {
  if (!filteredQuizList.length) return;
  if (isChecking) return;
  clearTimeout(checkTimeout);
  const val = answerEl.value;
  if (!val.trim()) { feedbackEl.textContent = ""; return; }
  const current = filteredQuizList[index];
  if (checkAnswer(val, current)) { isChecking = true; showCorrect(); return; }
  checkTimeout = setTimeout(()=>{}, 300);
});

/* Show answer button */
function showAnswer(){
  const it = filteredQuizList[index];
  if (!it) return hideShowAnswer();
  let text = Array.isArray(it.a) ? it.a.join(" / ") : it.a;
  if (it.r) text += `\n${it.r}`;
  showAnswerBtn.textContent = text;
}
function resetShowAnswer(){ showAnswerBtn.textContent = "Ver respuesta"; }
function hideShowAnswer(){ showAnswerBtn.style.display = "none"; }
showAnswerBtn.addEventListener('click', showAnswer);

/* Progress pills (neutras) */
const totalItems = filteredQuizList.length;
const maxPills = 5;
const blockSize = totalItems ? Math.ceil(totalItems / maxPills) : 1;
const totalPills = Math.ceil(totalItems / blockSize);
progressPills.innerHTML = "";
for (let i=0;i<totalPills;i++){
  const p = document.createElement('div');
  p.className = 'pill';
  p.innerHTML = '<div class="pill-fill"></div>';
  progressPills.appendChild(p);
}

function animatePill(pill){
  navigator.vibrate?.(20);
  pill.classList.add('vibrate');
  setTimeout(()=>pill.classList.remove('vibrate'), 500);
  try{ pillSound.currentTime = 0; pillSound.play(); }catch(e){}
}

function updatePills(cur){
  const pills = Array.from(progressPills.children);
  const pillIndex = Math.floor(cur / blockSize);
  const progress = blockSize ? ((cur % blockSize) / blockSize) : 1;
  pills.forEach((p,i)=>{
    const f = p.querySelector('.pill-fill');
    if (i < pillIndex){ f.style.width = '100%'; p.classList.add('filled'); }
    else if (i === pillIndex){ f.style.width = (progress*100) + '%'; p.classList.remove('filled'); }
    else { f.style.width = '0%'; p.classList.remove('filled'); }
  });
  if (cur % blockSize === 0 && cur !== 0){
    const trg = pills[Math.max(0, pillIndex-1)];
    if (trg) animatePill(trg);
  }
}

/* Init */
showQuestion();
document.body.addEventListener('click', (e)=>{ if (e.target !== answerEl) answerEl.focus(); });
</script>
</body>
</html>
