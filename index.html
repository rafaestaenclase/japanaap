<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
<title>Practicar Japon√©s</title>
<style>
:root{
  --bg: #0B0B0E;
  --fg: #E8E8E8;
  --muted: #bdbdbd;
  --card-bg: rgba(255,255,255,0.02);
  --card-bg-strong: rgba(255,255,255,0.10);
  --border: #3a3a3a;
  --accent: #888;
}

/* 1. Reset & Accesibilidad */
*{ -webkit-tap-highlight-color: transparent; box-sizing: border-box; font-size:15px; color:var(--fg); outline:none; user-select:none }
html,body{height:100%; margin:0; padding:0}
body {
  font-family: "Noto Sans JP", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg);
  line-height:1.55;
  max-width: 700px;
}

/* Ocultar scrollbar de todos los elementos scrollables (agrupado) */
#studyDiv, #sectionsContainer {
  -ms-overflow-style: none;
  scrollbar-width: none;
  overflow: auto;
}
#studyDiv::-webkit-scrollbar, #sectionsContainer::-webkit-scrollbar { display: none }

/* Botones */
button, [role="button"]{ touch-action: manipulation; cursor: pointer; border: none; background: none; transition: .2s }

/* Layout principal */
#studyDiv {
  position: fixed; top:0; left:0; height:calc(75% - 20px); width:50%; z-index:1;
  display:flex; flex-direction:column; align-items:flex-start; padding:8px;
}
#studyDiv .title{ font-size:1.2rem; margin:0 0 8px 10px; font-weight:600 }

#sectionsContainer {
  position: fixed; width:50%; top:0; bottom:0; right:0; overflow:auto;
  padding-top:30vh; padding-bottom:40px;
}

.category-block {
  margin-bottom: 15px;
}

.category-block > h2 {
  margin: 0px;
}

/* Secciones */
.section{ width:100%; border-radius:6px; padding:2px 6px; position:relative }
.section-title{
  display:flex; justify-content:space-between; align-items:center; cursor:pointer;
  text-decoration:underline; text-underline-offset:6px; font-weight:600; letter-spacing:.4px;
}

/* Grid de niveles */
.level-grid{
  display:block; height:0; overflow:hidden; opacity:0; transform:translateY(-6px);
  transition: height 350ms cubic-bezier(.4,0,.2,1), opacity 260ms ease, transform 320ms cubic-bezier(.4,0,.2,1);
  margin-top:8px; padding-left:28px; position:relative;
}
.level-grid.expanded{ display:flex; flex-direction:column; gap:8px; height:auto; opacity:1; transform:translateY(0) }
.level-grid.expanded::before{
  content:""; position:absolute; left:5px; top:0; bottom:12px; width:2px; background:#5c5c5c; border-radius:2px; opacity:.8;
}
.level-card.fav::before { background: #ffca28 !important; }

/* Tarjetas */
.level-card{
  padding:10px 8px; margin-left:0; border-radius:6px; text-align:left; font-size:.95rem;
  position:relative; cursor:pointer; transition:all .18s; width:calc(100% - 28px); background:var(--card-bg);
}
.level-card::before{ content:""; position:absolute; left:-15px; top:50%; transform:translateY(-50%); width:12px; height:2px; background:#6d6d6d; border-radius:2px; opacity:.9 }
.level-card.selected{ background:var(--card-bg-strong); box-shadow: inset 0 0 8px rgba(255,255,255,0.12); border-left:3px solid var(--accent) }
.level-card h3{ margin:0; font-size:15px; font-weight:500; letter-spacing:.3px }

/* Lista de estudio (nuevo formato sin tabla) */
.study-list{ display:flex; flex-direction:column; gap:10px; width:100% }
.study-item{ background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:6px; line-height:1.4 }
.study-q{ font-weight:400; color:var(--fg); margin-bottom:4px; font-size:13px; background:rgba(255,255,255,0.10); padding:8px }
.study-a{ color:var(--muted); font-size:.95rem; margin-left:12px; padding:2px 0 4px 0 }
.study-a > div{ margin:2px 0; font-size:16px }
.romaji{ font-style:italic; opacity:.85; margin-top:4px }

/* Acci√≥n inferior */
#actionDiv{
  position:fixed; bottom:0; left:0; width:50%; height:25%; display:flex; gap:8px; flex-wrap:wrap; align-content:center; flex-direction:column; z-index:10; paddomg
}
#actionDiv > *{ margin:0; width:90%; font-size:15px; font-weight:500; letter-spacing:.3px; background:rgba(255,255,255,0.10); border-radius:6px; padding:5px; text-align:center }

</style>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="studyDiv" aria-live="polite"></div>

  <div id="actionDiv" role="toolbar" aria-label="Acciones">
    <div id="practiceButton" role="button" tabindex="0">Practicar</div>
    <div id="addFav" role="button" tabindex="0">A√±adir a favoritos</div>
    <div id="showFav" role="button" tabindex="0">Ver solo favoritos</div>
  </div>

  <div id="sectionsContainer" ></div>

<script src="./js/allLists.js"></script>
<script>
/* ---------- Utilidades ---------- */
const $ = sel => document.getElementById(sel);
const ALL_LISTS = Object.values(window).filter(l => l?.levels && (l.name || l.listName));
const container = $("sectionsContainer");
const studyDiv = $("studyDiv");
const practiceBtn = $("practiceButton");
let selectedCard = null;
let showingOnlyFavs = false;

/* ---------- Favoritos ---------- */
const FAV_KEY = 'jp_study_favorites_v1';
const SHOW_FAV_KEY = 'jp_study_showOnlyFavs';
function favKey(listName, levelIndex) { return `${listName}::${levelIndex}`; }
function loadFavorites() { try { const raw = localStorage.getItem(FAV_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
function saveFavorites(arr) { try { localStorage.setItem(FAV_KEY, JSON.stringify(arr)); } catch(e) {} }
function getFavoritesSet() { return new Set(loadFavorites()); }
function isFavorite(listName, levelIndex) { return getFavoritesSet().has(favKey(listName, levelIndex)); }
function addFavorite(listName, levelIndex) { const set = getFavoritesSet(); set.add(favKey(listName, levelIndex)); saveFavorites([...set]); }
function removeFavorite(listName, levelIndex) { const set = getFavoritesSet(); set.delete(favKey(listName, levelIndex)); saveFavorites([...set]); }
function updateCardFavState(card) { const ln = card.dataset.listName; const idx = card.dataset.index; if (isFavorite(ln, idx)) card.classList.add('fav'); else card.classList.remove('fav'); }
function updateAllCardsFavState() { Array.from(container.querySelectorAll('.level-card')).forEach(updateCardFavState); }

/* ---------- Crear elemento ---------- */
function el(tag, { cls, text, attrs } = {}) { const e = document.createElement(tag); if(cls)e.className=cls; if(text!==undefined)e.textContent=text; if(attrs)Object.entries(attrs).forEach(([k,v])=>e.setAttribute(k,v)); return e; }

/* ---------- Crear grid ---------- */
function createGrid(listObj) {
  const section = el('div', { cls: 'section' });
  section.id = listObj.listName || (listObj.name || 'sin_nombre').replace(/\s+/g,'_');
  const title = el('div', { cls: 'section-title', text: listObj.name || "Sin nombre" });
  const grid = el('div', { cls: 'level-grid' });
  (listObj.levels || []).forEach((lvl,i)=>{
    const card = el('div',{cls:'level-card'});
    card.dataset.listName = listObj.listName || listObj.name || '';
    card.dataset.index = String(i);
    card.setAttribute('role','button'); card.setAttribute('tabindex','0');
    const h = el('h3',{text:lvl.name||`Nivel ${i+1}`}); card.appendChild(h);
    updateCardFavState(card);
    attachCardEvents(card); // <-- Importante
    grid.appendChild(card);
  });
  title.addEventListener('click',()=>toggleGrid(grid,title));
  section.appendChild(title); section.appendChild(grid);
  return section;
}

/* ---------- Toggle grid ---------- */
function toggleGrid(gridEl,titleEl){ const expanded = gridEl.classList.toggle('expanded'); if(expanded){ requestAnimationFrame(()=>{gridEl.style.height=gridEl.scrollHeight+'px'; titleEl.classList.add('expanded');}); } else { gridEl.style.height='0px'; titleEl.classList.remove('expanded');} }

/* ---------- Inicializar secciones ---------- */
function initSectionsOnly(){
  const categories=[...new Set(ALL_LISTS.map(l=>l.category||'default'))];
  const frag=document.createDocumentFragment();
  categories.forEach(cat=>{
    const catDiv=el('div',{cls:'category-block'}); catDiv.dataset.category=cat;
    const h2=el('h2',{text: cat==='write'?'‚úçÔ∏è Escritura':cat==='vocabulary'?'üìñ Vocabulario':cat==='grammar'?'üß© Gram√°tica':cat}); catDiv.appendChild(h2);
    ALL_LISTS.filter(l=>(l.category||'default')===cat).forEach(l=>catDiv.appendChild(createGrid(l)));
    frag.appendChild(catDiv);
  });
  container.appendChild(frag);
}

/* ---------- Manejo de selecci√≥n ---------- */
function attachCardEvents(card){
  card.addEventListener('click',()=>handleCardClick(card));
  card.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); card.click(); } });
}

function handleCardClick(card){
  const deselect = selectedCard===card;
  if(selectedCard) selectedCard.classList.remove('selected');
  if(deselect){ selectedCard=null; studyDiv.innerHTML=''; showGanbatte(); return; }
  card.classList.add('selected'); selectedCard=card;
  const ln=card.dataset.listName;
  const listObj=ALL_LISTS.find(l=>(l.listName===ln)||(l.name===ln));
  const lvl=listObj?.levels?.[Number(card.dataset.index||0)];
  renderStudyDiv(lvl);
  $("addFav").textContent=isFavorite(ln,card.dataset.index)?'Quitar de favoritos':'A√±adir a favoritos';
}

/* ---------- Render panel de estudio ---------- */
function renderStudyDiv(level){
  studyDiv.innerHTML='';
  if(!level){ studyDiv.innerHTML="<p class='title'>Nivel no encontrado</p>"; return; }
  const title=el('p',{cls:'title',text:level.name||"Nivel"}); studyDiv.appendChild(title);
  const listContainer=el('div',{cls:'study-list'});
  (level.items||[]).forEach(it=>{
    const itemDiv=el('div',{cls:'study-item'});
    const qDiv=el('div',{cls:'study-q',text:it.q??""}); itemDiv.appendChild(qDiv);
    const aDiv=el('div',{cls:'study-a'});
    if(Array.isArray(it.a)) it.a.forEach(val=>aDiv.appendChild(el('div',{text:val??""})));
    else aDiv.appendChild(el('div',{text:it.a??""}));
    if(it.r) aDiv.appendChild(el('div',{cls:'romaji',text:it.r}));
    itemDiv.appendChild(aDiv); listContainer.appendChild(itemDiv);
  });
  studyDiv.appendChild(listContainer);
}

/* ---------- Acciones inferiores ---------- */
practiceBtn.addEventListener('click',()=>{
  if(!selectedCard)return;
  const params=new URLSearchParams({play:selectedCard.dataset.listName,level:selectedCard.dataset.index});
  location.href=`practiceGround.html?${params.toString()}`;
});

$("addFav").addEventListener('click',()=>{
  if(!selectedCard){ alert('Selecciona primero una tarjeta'); return; }
  const ln=selectedCard.dataset.listName; const idx=selectedCard.dataset.index;
  if(isFavorite(ln,idx)){ removeFavorite(ln,idx); selectedCard.classList.remove('fav'); $("addFav").textContent='A√±adir a favoritos'; }
  else { addFavorite(ln,idx); selectedCard.classList.add('fav'); $("addFav").textContent='Quitar de favoritos'; }
  if(showingOnlyFavs) renderFavoritesView();
});

$("showFav").addEventListener('click',()=>{
  showingOnlyFavs=!showingOnlyFavs;
  localStorage.setItem(SHOW_FAV_KEY, showingOnlyFavs ? '1' : '0'); // <--- Guardamos el estado
  $("showFav").textContent=showingOnlyFavs?'Ver todo':'Ver solo favoritos';
  selectedCard=null; studyDiv.innerHTML=''; showGanbatte();
  if(showingOnlyFavs) renderFavoritesView();
  else { container.innerHTML=''; initSectionsOnly(); updateAllCardsFavState(); }
});

/* ---------- Render solo favoritos ---------- */
function renderFavoritesView(){
  container.innerHTML='';
  const favKeys=loadFavorites();
  if(!favKeys.length){ container.appendChild(el('div',{cls:'category-block',text:'No hay favoritos a√∫n.'})); return; }
  const frag=document.createDocumentFragment();
  favKeys.forEach(key=>{
    const [listName, idxStr]=key.split('::'); const idx=Number(idxStr);
    const listObj=ALL_LISTS.find(l=>l.listName===listName||l.name===listName);
    if(!listObj) return; const level=listObj.levels[idx]; if(!level) return;
    const section=el('div',{cls:'section'});
    const title=el('div',{cls:'section-title',text:`${listObj.name||listObj.listName} ¬∑ ${level.name||`Nivel ${idx+1}`}`});
    section.appendChild(title);
    const grid=el('div',{cls:'level-grid expanded'}); grid.style.height='auto';
    const card=el('div',{cls:'level-card fav',attrs:{role:'button',tabindex:'0'}});
    card.dataset.listName=listObj.listName||listObj.name; card.dataset.index=String(idx);
    card.innerHTML=`<h3>${level.name||`Nivel ${idx+1}`}</h3>`;
    attachCardEvents(card); // <-- Asegura selecci√≥n
    grid.appendChild(card); section.appendChild(grid); frag.appendChild(section);
  });
  container.appendChild(frag);
}

/* ---------- Mensaje inicial ---------- */
function showGanbatte(){ if(!studyDiv.innerHTML.trim()) studyDiv.innerHTML="<h1 class='title'>„Åå„Çì„Å∞„Å£„Å¶</h1><h3 style='font-weight:bold;padding-left:10px;margin-top:0px'>√Ånimo</h3>"; }

/* ---------- Init ---------- */
window.addEventListener('DOMContentLoaded',()=>{
  const savedFav = localStorage.getItem(SHOW_FAV_KEY);
  showingOnlyFavs = savedFav==='1';
  $("showFav").textContent = showingOnlyFavs ? 'Ver todo' : 'Ver solo favoritos';
  if(showingOnlyFavs) renderFavoritesView();
  else initSectionsOnly();
  updateAllCardsFavState();
  showGanbatte();
});
</script>


</body>
</html>
